{% load static %}

<link rel="stylesheet" href="{% static 'css/notifications.css' %}">
<audio id="notificationSound" src="{% static 'sounds/notification.mp3' %}" preload="auto"></audio>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var requests = Number('{{ requests|length }}');
    if (requests > 0) {
      document.getElementById('notificationSound').play();
    }
  });

  let notificationSocket = null;
  if (window.location.protocol === "https:") {
    notificationSocket = new WebSocket('wss://' + window.location.host + '/ws/notifications/');
  } else {
    notificationSocket = new WebSocket('ws://' + window.location.host + '/ws/notifications/');
  }
  notificationSocket.onopen = function() {
    console.log('WebSocket connection established for notifications!');
  };
  notificationSocket.onmessage = function(e) {
    console.log('WebSocket message received:', e.data);
    const data = JSON.parse(e.data);
    if (data.message) {
      document.getElementById('notificationSound').play();
      // Optionally, show a toast or alert: alert(data.message);
      const icon = document.getElementById('notification-icon');
      let count = parseInt(icon.dataset.count || '0', 10) + 1;
      icon.dataset.count = count;
      icon.classList.add('notification-badge');
    }
  };
  notificationSocket.onerror = function(e) {
    console.error('WebSocket error:', e);
  };
  notificationSocket.onclose = function(e) {
    console.warn('WebSocket closed:', e);
  };
</script>

<div class="notification-panel">
  <h3 class="notification-title">ðŸ”” Notifications</h3>
  <ul class="notification-list">
    {# Friend Requests #}
    {% for request in requests %}
      <li class="notification-item">        <div class="notification-content">
          <div class="notification-user-info">
            <a href="/profile/{{ request.from_user.id }}/" style="text-decoration: none;">
              {% if request.from_user.profile_picture %}
                <img src="{{ request.from_user.profile_picture.url }}" alt="Avatar" class="friend-request-avatar">
              {% else %}
                <img src="{% static 'img/default-avatar.png' %}" alt="Default Avatar" class="friend-request-avatar">
              {% endif %}
            </a>
            <div class="notification-text">
              <div class="notification-name">{{ request.from_user.full_name }}</div>
              <div class="notification-time">{{ request.timestamp|timesince }} ago</div>
            </div>
          </div>
          <div class="notification-actions">
            <a href="{% url 'notifications:accept_friend_request' request.id %}" class="btn-accept">Accept</a>
            <a href="{% url 'notifications:decline_friend_request' request.id %}" class="btn-decline">Decline</a>
          </div>
        </div>
      </li>
    {% empty %}
      <li class="notification-item empty">No friend requests.</li>
    {% endfor %}
    {# Other Notifications #}
    {% for notification in notifications %}
      <li class="notification-item">        <div class="notification-content">
          <div class="notification-user-info">
            {% if notification.sender %}
              <a href="/profile/{{ notification.sender.id }}/" style="text-decoration: none;">
                {% if notification.sender.profile_picture %}
                  <img src="{{ notification.sender.profile_picture.url }}" alt="Avatar" class="friend-request-avatar">
                {% else %}
                  <img src="{% static 'img/default-avatar.png' %}" alt="Default Avatar" class="friend-request-avatar">
                {% endif %}
              </a>
            {% else %}
              <img src="{% static 'img/default-avatar.png' %}" alt="Default Avatar" class="friend-request-avatar">
            {% endif %}
            <div class="notification-text">
              <div class="notification-name">
                {% if notification.notification_type == 'message' %}
                  New message from {{ notification.sender.full_name }}
                {% elif notification.notification_type == 'like' %}
                  {{ notification.sender.full_name }} liked your post
                {% elif notification.notification_type == 'comment' %}
                  {{ notification.sender.full_name }} commented: {{ notification.message|truncatechars:30 }}                {% elif notification.notification_type == 'event_join_request' %}
                  {% if notification.sender %}
                    {{ notification.sender.full_name }} requested to join your event
                  {% else %}
                    {{ notification.message }}
                  {% endif %}
                  {# Show Accept/Decline buttons if the current user is the event creator and we have a join request ID #}
                  {% if notification.related_object_id and request.user == notification.user %}
                    <div class="notification-actions">
                      <a href="{% url 'events:handle_join_request' notification.related_object_id 'accept' %}" class="btn-accept">Accept</a>
                      <a href="{% url 'events:handle_join_request' notification.related_object_id 'decline' %}" class="btn-decline">Decline</a>
                    </div>
                  {% endif %}
                {% else %}
                  {{ notification.message }}
                {% endif %}
              </div>
              <div class="notification-time">{{ notification.timestamp|timesince }} ago</div>
            </div>
          </div>          {% if notification.url or notification.link %}
            <a href="{{ notification.url|default:notification.link }}" class="btn-view">View</a>
          {% endif %}
        </div>
      </li>
    {% empty %}
      <li class="notification-item empty">No notifications.</li>
    {% endfor %}
  </ul>
</div>
